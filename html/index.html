<html>
<meta charset="utf-8" />
<head>
	<title>COIoT Home</title>
	<style>
	.button {
		display:inline-block;
		border: solid 5px;
		background-color: #ddd;
		box-shadow: none;
		border-radius: 10px;
		width: 80px;
		height:80px;
		margin: 5px;
		cursor: pointer;
	}

	.button > .light {
		position: relative;
		width: 60px;
		left: 5px;
		height: 10px;
		border: solid 5px #655;
	}

	.on {
		border-color: #2d3;
	}

	.off {
		border-color: #f62;
	}
	</style>
	<script type="text/javascript">
	'use strict';

	var devices = [];

	function find_device(id) {
		var dlen = devices.length;
		for(var i = 0; i < dlen; i++) {
			var device = devices[i];
			if(device.id == id) {
				return device;
			}
		}
		throw Error("no such device "+id);
	}

	function put_device_refresh_cb(id) {
		return function(txt) {
			http_async('GET', '/ws/v1/device/'+id+'/*', function(js) {
				var device = find_device(id);
				console.log("update #"+id);
				device.refresh(js['image'], js['on']);
			});
		};
	}

	class Device {
		constructor(id, imgurl, on) {
			this.id = id;
			this.handle = document.createElement('a');
			this.handle.className = "button " + (this.handle.state?"on":"off");
			this.handle.style.backgroundSize = "contain";
			this.handle.onmousedown = function() {
				this.state = !this.state;
				http_async('PUT', '/ws/v1/device/'+id+'/on',
					put_device_refresh_cb(id),
					this.state);
			};
			this.refresh(imgurl, on);

			document.getElementById('render').appendChild(this.handle);
		}

		refresh(imgurl, on) {
			this.handle.state = on;
			this.handle.className = "button " + (this.handle.state?"on":"off");
			this.handle.style.backgroundImage = 'url("/img/' + imgurl + '")';
		}
	}

	function http_async(verb, url, callback, arg) {
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.onreadystatechange = function() {
			if (xmlHttp.readyState == 4) {
				switch(xmlHttp.status) {
				case 200:
					callback(JSON.parse(xmlHttp.responseText));
					break;
				case 204:
					callback(undefined);
					break;
				}
			}
		}
		xmlHttp.open(verb, url, true);
		if(arg === undefined) {
			xmlHttp.send(null);
		} else {
			var res = JSON.stringify(arg);
			xmlHttp.setRequestHeader("Content-Type", "application/json");
			xmlHttp.send(res);
		}
	}

	function add_devices_cb(js) {
		for(var id in js) {
			var device = js[id];
			console.log("add #"+id);
			devices.push(new Device(id, device['image'], device['on']));
		}
	}

	function main() {
		http_async('GET', '/ws/v1/device/*/*', add_devices_cb);
	}
	</script>
</head>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0">
<body style="margin: 0; overflow:scroll; background-color: #ffe">
	<div id="render"></div>

	<script type="text/javascript" defer="defer">
	main();
	</script>
</body>
</html>
